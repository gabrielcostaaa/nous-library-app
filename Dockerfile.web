# Stage 1: Build dos Assets Estáticos
FROM node:20-alpine AS builder

WORKDIR /usr/src/app

# Argumento para receber a URL da API do docker-compose
ARG VITE_API_URL

# Copia arquivos de dependência da raiz e do frontend
COPY package.json yarn.lock ./
COPY packages/web/package.json ./packages/web/

# Instala TODAS as dependências
RUN yarn install --frozen-lockfile

# Copia o código fonte do frontend
COPY packages/web ./packages/web

# Seta a variável de ambiente para o build do Vite
ENV VITE_API_URL=$VITE_API_URL

# Executa o build de produção do frontend (usando o script da raiz)
RUN yarn build:web

# Stage 2: Servir os Assets com Nginx
FROM nginx:stable-alpine

# Remove a configuração padrão do Nginx
RUN rm /etc/nginx/conf.d/default.conf

# Copia nossa configuração customizada do Nginx
COPY nginx.conf /etc/nginx/conf.d/default.conf

# Copia os assets buildados do stage anterior para a pasta que o Nginx serve
COPY --from=builder /usr/src/app/packages/web/dist /usr/share/nginx/html

# Expõe a porta 80 (padrão do Nginx)
EXPOSE 80

# Comando padrão para iniciar o Nginx
CMD ["nginx", "-g", "daemon off;"]